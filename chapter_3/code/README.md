<h1>Scripts for the analysis of the metabolomic data in "Evolution and regulation of microbial secondary metabolism"</h1>
<h2>Metabolomic analysis of <em>P. aeruginosa</em> in context of rhamnolipid production</h2>
<div style="text-align: justify">These R scripts do the parsing of the metabolomic data obtained from different clinical isolates of <em>Pseudomonas aeruginosa</em> and reference strain PA14. For using them the variable called "rootDir" needs to be changed to the path where the user downloaded this gitHub repository. All the scripts create "plots" and "results" directories if they don't exist. The order the scripts need to be executed for running the pipeline is the following: <br>
<h3>1-parsing.R</h3>
Parse metabolite peak area data, obtained with Liquid Chromatography-Mass Spectrometry (LC-MS). The input data consists in two datasets, an old one with some putative metabolites and a newer one that with a few metabolites added and some metabolite names updated. The script rescues some of the putative compounds of the old dataset based on the annotation of the clinical isolates, and parses old and new datasets in a single file: mets_peakRaw_parsed.csv.
<h3>2-figS5_norm.R</h3>
This script first imputes missing values of the parsed peak area data, generating in the process Supplementary figures 5B-1 and 5B-2 (figS5_B.1.pdf and figS5_B.2.pdf). After imputation obtains internal standards with a Kruskal Wallis test for further normalization, considering replicates of a same strain as a group. Metabolites with adjusted <em>p-</em>value (with Benjamini Hochberg method) above 0.05 are considered nonchanging, and therefore used as Internal Standards for normalization. <br>Imputed data is log-transformed, Supplementary figure S5A (figS5_A.pdf) is generated, and several normalization methods are tested with the aim of selecting the best performing one. Mean across vs. mean within group distance plot (normMet_avDists.pdf), silhouette plot (normMet_silh.pdf), and across-group and within-group Relative Log Abundance (RLA) plots are generated in the process (RLA_AG_strain.pdf and RLA_WG_strain.pdf). This analysis determines CCMN (cross-contribution compensating multiple standard normalization) method as the best performing one, based on its ability to remove unwanted variation (between replicates) while conserving the maximum difference between isolates. After normalization Internal Standards are left out of the resulting dataset. This dataset is written to mets_ccmn.tsv (use TSV file to avoid data loss produced by float value rounding). 
<h3>3-figS6_unsupAnalysis.R</h3>
This script runs two unsupervised approaches on the CCMN normalized metabolomics data. First performs a Hierarchical Clustering Analysis (HCA). The data is scaled, centered and clustered using all the metabolites, both variable and putative: we consider that, despite not knowing exactly what they are, they can be used for clustering as the peaks appear in all the samples, meaning that should not be artifacts. Euclidean distance and Ward D aggregation method are used. A heatmap is obtained, indicating rhamnolipid production phenotype (triple category) of each <em>P. aeruginosa strain</em>: Supplementary Figure 6A (figS6_A.pdf). For plotting purposes and for the sake of clarity, these putatives are left out of the plot despite being used in the clustering.<br>
Next a Principal Component Analysis (PCA) is run. Median metabolite values are obtained for the replicates of each strain and PCA is performed over these values. A biplot is generated (Supplementary Figure 6B, figS6_A.pdf), showing just the top 11 variables contributing to the two principal components with the aim of not producing an overcrowded plot, and coloring the samples according to their rhamnolipid production phenotype (triple category). Finally produces a TSV file of the CCMN normalized data with the putative compounds removed for use in downstream analyses: mets_ccmn_noPut.tsv.
<h3>4-FELLA.R</h3>
Perform metabolic pathway enrichment of the differential metabolites. First performs a Mann Whitney U test for determining the differential metabolites between rhamnolipid producers and non producers (Benjamini-Hochberg adjusted <em>p-</em>value < 0.05). The result of this test is saved to mwRhamn_result.csv. <br>
The statistically significant compounds are used as input for performing a metabolic pathway enrichment with FELLA algorithm. This method relies on the construction of a graph based on all the entries in KEGG for, in this case, <em>P. aeruginosa strain</em> strain PA14 (pau code in KEGG). As KEGG is updated frequently, the result might be slightly different to the one shown in our publication. The graph of the entries better connected to our input metabolites is plotted in FELLA_graph_res.pdf, while the results table is written to FELLA_tab_res.csv.
<h3>5-fig5_AB_S7_supAnalysis.R</h3>
Run supervised analysis: fit an orthogonal projection to latent structures discriminant analysis (OPLS-DA) model to the CCMN-normalized (without putative metabolites), providing as the response variable rhamnolipid production (binary category). OPLS-DA is run with a single predictive component and 3 orthogonal components. R2 and Q2, are assessed by default by the function with 7-fold cross validation. Significance of the model is determined by permutation test (n = 2000).<br>
The score plot of the resulting model is then obtained (Figure 5A, fig5_A.pdf). Then loadings for each metabolite in the Predictive component of the OPLS-DA model are obtained. A barplot is generated, aggrupating the metabolites according to which of the enriched pathways determined by FELLA they participate in: Supplementary Figure 7 (figS7.pdf). A simplified version of this barplot is generated too: Figure 5B (fig5_B.pdf). In this plot all the pathways involved in amino acid metabolism are merged into a single category. The other pathways shown are TCA cycle and Pentose phosphate pathway. This way only the most altered pathways are shown and duplicated metabolites caused by them participating in several metabolic pathways are avoided.<br></div>